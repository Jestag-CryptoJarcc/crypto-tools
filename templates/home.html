{% extends "base.html" %}
{% set page_title = "Crypto Toolkit" %}
{% block content %}
<header class="hero">
    <div class="hero-layout">
        <div class="hero-copy">
            <div class="kicker">INTRO</div>
            <h1>Welcome to the Crypto Toolkit</h1>
            <p class="lead">A clean, personal crypto dashboard built for speed, clarity, and day‑to‑day decisions.</p>
            <p class="muted">This page is the heartbeat of the toolkit. It gives you a fast read on the market, quick access to tools, and a personal watchlist you can trust. No noise, no hype — just the essentials laid out clearly.</p>
            <div class="hero-notes">
                <div>
                    <strong>Live Market</strong>
                    <span class="muted">Top coins, price moves, volume, and market cap at a glance.</span>
                </div>
                <div>
                    <strong>Quick Tools</strong>
                    <span class="muted">Converters, sentiment, and helpers that keep you moving.</span>
                </div>
                <div>
                    <strong>My Watchlist</strong>
                    <span class="muted">The coins that matter most to me, always pinned and easy to read.</span>
                </div>
            </div>
            <p class="muted">Built for beginners and veterans alike — friendly when you’re learning, fast when you already know what you need.</p>
        </div>
        <div class="home-guide-panel home-guide-lower">
            <div class="card-header">
                <h2>Site Guide</h2>
                <span class="pill">Start here</span>
            </div>
            <p class="muted">This site is personal. I built it to keep crypto calm, organized, and focused on real signal — not noise.</p>
            <details class="home-guide">
                <summary>
                    <span class="legend-title">Why I built this</span>
                    <span class="legend-hint muted">Click to expand</span>
                </summary>
                <div class="home-guide-copy">
                    <p>I wanted a single home base that shows the market clearly without the chaos. Most crypto sites overload you with hype and distractions. I built the opposite: fast signal, clean layout, and only the tools I actually use.</p>
                    <p>This toolkit keeps my watchlist, quick checks, and learning guides in one place. The goal is simple: help me make steady decisions, not emotional ones.</p>
                    <p>I built it for myself first, but I share it because I know others want a calm, honest way to use crypto. If it helps you move smarter, it’s doing its job.</p>
                </div>
            </details>
        </div>
    </div>
</header>

<section class="card">
    <div class="market-head">
        <div>
            <h2 class="market-title" data-title-top>Top 50 Crypto</h2>
            <p class="muted market-subtitle" data-subtitle-top>Top 50 coins by market cap with price, 24h change, volume, and market cap.</p>
            <p class="muted market-subtitle hidden" data-subtitle-my>My personal picks and long‑term holds.</p>
        </div>
        <div class="market-tabs">
            <button class="chip tab-btn active" data-tab="top15" type="button">Top 50 Coins</button>
            <button class="chip secondary tab-btn" data-tab="mycoins" type="button">Coins Important to Me</button>
        </div>
    </div>
    <details class="badge-legend">
        <summary>
            <span class="legend-title">Badge Legend</span>
            <span class="legend-hint muted">Click to expand</span>
        </summary>
        <div class="legend-grid">
            <div class="legend-item">
                <span class="badge top crown" aria-hidden="true">👑</span>
                <div>
                    <strong>Top 3</strong>
                    <span class="muted">Rank 1–3 by market cap.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge top medal" aria-hidden="true">🏅</span>
                <div>
                    <strong>Top 10</strong>
                    <span class="muted">Rank 4–10 by market cap.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge mega gem" aria-hidden="true">💎</span>
                <div>
                    <strong>Mega Cap</strong>
                    <span class="muted">Market cap ≥ $100B.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge large" aria-hidden="true">🏛</span>
                <div>
                    <strong>Large Cap</strong>
                    <span class="muted">Market cap ≥ $10B.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge mid" aria-hidden="true">🏙</span>
                <div>
                    <strong>Mid Cap</strong>
                    <span class="muted">Market cap ≥ $1B.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge hot flame" aria-hidden="true">🔥</span>
                <div>
                    <strong>Hot 24h</strong>
                    <span class="muted">24h change ≥ +5%.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge cold snow" aria-hidden="true">❄</span>
                <div>
                    <strong>Cold 24h</strong>
                    <span class="muted">24h change ≤ −5%.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge vol bolt" aria-hidden="true">⚡</span>
                <div>
                    <strong>High Vol</strong>
                    <span class="muted">Abs 24h change ≥ 8%.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge up7d rocket" aria-hidden="true">🚀</span>
                <div>
                    <strong>Up 7D</strong>
                    <span class="muted">7d change ≥ +10%.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge down7d dip" aria-hidden="true">📉</span>
                <div>
                    <strong>Down 7D</strong>
                    <span class="muted">7d change ≤ −10%.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge stable" aria-hidden="true">🪙</span>
                <div>
                    <strong>Stablecoin</strong>
                    <span class="muted">Price pegged to fiat (USD/EUR, etc.).</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge legacy" aria-hidden="true">🏆</span>
                <div>
                    <strong>Legacy Blue Chip</strong>
                    <span class="muted">BTC/ETH class assets.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge l1" aria-hidden="true">🌐</span>
                <div>
                    <strong>Layer 1</strong>
                    <span class="muted">Base chain smart‑contract network.</span>
                </div>
            </div>
            <div class="legend-item">
                <span class="badge default" aria-hidden="true">🔹</span>
                <div>
                    <strong>Top 50</strong>
                    <span class="muted">Top 50 by market cap.</span>
                </div>
            </div>
        </div>
    </details>
    <div class="market-panel" data-panel="top15">
        <div class="market-list home-scroll-list paged-list" data-page-size="20">
        {% if top_coins %}
        {% for coin in top_coins %}
        <div class="market-row" data-id="{{ coin.id }}">
            <div class="market-coin">
                {% if coin.image %}
                <img src="{{ coin.image }}" alt="{{ coin.symbol }} logo" loading="lazy">
                {% endif %}
                <div>
                    <strong>{{ coin.name }}</strong>
                    <div class="muted">
                        <span>{{ coin.symbol }}</span>
                        {% if coin.rank %}
                        <span>· #{{ coin.rank }}</span>
                        {% endif %}
                    </div>
                    <div class="badge-box" aria-label="Market badges">
                        {% set sym = (coin.symbol or '')|lower %}
                        {% set name = (coin.name or '')|lower %}
                        {% set cid = (coin.id or '')|lower %}
                        {% set ns = namespace(count=0) %}
                        {% if coin.rank and coin.rank <= 3 %}
                        <span class="badge top crown" title="Top 3">👑</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if coin.rank and coin.rank <= 10 %}
                        <span class="badge top medal" title="Top 10">🏅</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if coin.market_cap and coin.market_cap >= 100000000000 %}
                        <span class="badge mega gem" title="Mega Cap">💎</span>{% set ns.count = ns.count + 1 %}
                        {% elif coin.market_cap and coin.market_cap >= 10000000000 %}
                        <span class="badge large" title="Large Cap">🏛</span>{% set ns.count = ns.count + 1 %}
                        {% elif coin.market_cap and coin.market_cap >= 1000000000 %}
                        <span class="badge mid" title="Mid Cap">🏙</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if coin.change_24h is not none and coin.change_24h >= 5 %}
                        <span class="badge hot flame" title="Hot 24h">🔥</span>{% set ns.count = ns.count + 1 %}
                        {% elif coin.change_24h is not none and coin.change_24h <= -5 %}
                        <span class="badge cold snow" title="Cold 24h">❄</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if coin.change_24h is not none and coin.change_24h|abs >= 8 %}
                        <span class="badge vol bolt" title="High Volatility">⚡</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if coin.change_7d is not none and coin.change_7d >= 10 %}
                        <span class="badge up7d rocket" title="Up 7D">🚀</span>{% set ns.count = ns.count + 1 %}
                        {% elif coin.change_7d is not none and coin.change_7d <= -10 %}
                        <span class="badge down7d dip" title="Down 7D">📉</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if cid in [
                            'tether','usd-coin','dai','binance-usd','true-usd','paxos-standard','first-digital-usd',
                            'ethena-usde','frax','liquity-usd','gemini-dollar','usdd','crvusd','paypal-usd',
                            'eurc','tether-eurt','stasis-eurs','agora-dollar','angle-usd','usda','usdb','usde'
                        ] or sym in [
                            'usdt','usdc','dai','busd','tusd','usdp','fdusd','usde','frax','lusd','gusd','usdd','crvusd','pyusd','eurc','eurt','eurs','usda','usdb'
                        ] or ('usd' in name or 'dollar' in name or 'euro' in name or 'eur' in name) %}
                        <span class="badge stable" title="Stablecoin">🪙</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if sym in ['btc','eth'] %}
                        <span class="badge legacy" title="Legacy Blue Chip">🏆</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if cid in ['bitcoin','ethereum','solana','binancecoin','cardano','avalanche-2','tron','the-open-network','polkadot','polygon-ecosystem-token','near','aptos','sui','cosmos','algorand','hedera-hashgraph','injective-protocol','fantom','multiversx','tezos','sei-network','arbitrum','optimism'] %}
                        <span class="badge l1" title="Layer 1">🌐</span>{% set ns.count = ns.count + 1 %}
                        {% endif %}
                        {% if ns.count == 0 %}
                        <span class="badge default" title="Top 50">🔹</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="market-metrics">
                <div>
                    <span class="muted">Price</span>
                    <strong data-price>${{ "{:,.2f}".format(coin.price_usd) }}</strong>
                </div>
                <div>
                    {% if coin.change_24h is not none %}
                    <strong data-change class="{{ 'up' if coin.change_24h >= 0 else 'down' }}">
                        <span class="change-arrow">{{ '▲' if coin.change_24h >= 0 else '▼' }}</span>
                        {{ "{:+.2f}%".format(coin.change_24h) }} 24h
                    </strong>
                    {% else %}
                    <strong data-change class="muted">— 24h</strong>
                    {% endif %}
                    {% if coin.change_7d is not none %}
                    <strong class="change-7d {{ 'up' if coin.change_7d >= 0 else 'down' }}">
                        <span class="change-arrow">{{ '▲' if coin.change_7d >= 0 else '▼' }}</span>
                        {{ "{:+.2f}%".format(coin.change_7d) }} 7d
                    </strong>
                    {% else %}
                    <strong class="change-7d muted">— 7d</strong>
                    {% endif %}
                </div>
                <div>
                    <span class="muted">Volume</span>
                    <strong data-volume>${{ "{:,.0f}".format(coin.volume_24h) }}</strong>
                </div>
                <div>
                    <span class="muted">Market Cap</span>
                    <strong data-cap>${{ "{:,.0f}".format(coin.market_cap) }}</strong>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="muted">Unable to load market data right now. Please refresh in a moment.</p>
        {% endif %}
        </div>
        <div class="paged-controls">
            <button class="chip secondary load-more" type="button">Load more</button>
        </div>
    </div>
    <div class="market-panel hidden" data-panel="mycoins">
        {% if my_coins %}
        <div class="market-list home-scroll-list paged-list" data-page-size="15">
            {% for coin in my_coins %}
            <div class="market-row" data-my-id="{{ coin.id }}">
                <div class="market-coin">
                    {% if coin.image %}
                    <img src="{{ coin.image }}" alt="{{ coin.symbol }} logo" loading="lazy">
                    {% endif %}
                    <div>
                        <strong>{{ coin.name }}</strong>
                        <span class="muted">{{ coin.symbol }}</span>
                    </div>
                </div>
                <div class="market-metrics">
                    <div>
                        <span class="muted">Price</span>
                        <strong data-price>${{ "{:,.6f}".format(coin.price_usd) }}</strong>
                    </div>
                    <div>
                        <span class="muted">24h</span>
                        <strong data-change class="{{ 'up' if coin.change_24h >= 0 else 'down' }}">
                            <span class="change-arrow">{{ '▲' if coin.change_24h >= 0 else '▼' }}</span>
                            {{ "{:+.2f}%".format(coin.change_24h) }}
                        </strong>
                    </div>
                    <div>
                        <span class="muted">Volume</span>
                        <strong data-volume>${{ "{:,.0f}".format(coin.volume_24h) }}</strong>
                    </div>
                    <div>
                        <span class="muted">Market Cap</span>
                        <strong data-cap>${{ "{:,.0f}".format(coin.market_cap) }}</strong>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="paged-controls">
            <button class="chip secondary load-more" type="button">Load more</button>
        </div>
        {% else %}
        <p class="muted">Your important coins will show here once you add them.</p>
        {% endif %}
    </div>
</section>

{% endblock %}

{% block scripts %}
<script>
    const tabs = document.querySelectorAll('.market-tabs .tab-btn');
    const panels = document.querySelectorAll('.market-panel');
    const titleEl = document.querySelector('[data-title-top]');
    const subTop = document.querySelector('[data-subtitle-top]');
    const subMy = document.querySelector('[data-subtitle-my]');
    const applyTab = (target) => {
        panels.forEach((panel) => {
            panel.classList.toggle('hidden', panel.dataset.panel !== target);
        });
        if (titleEl) {
            titleEl.textContent = target === 'mycoins' ? 'Coins Important to Me' : 'Top 50 Crypto';
        }
        if (subTop && subMy) {
            subTop.classList.toggle('hidden', target === 'mycoins');
            subMy.classList.toggle('hidden', target !== 'mycoins');
        }
    };

    tabs.forEach((btn) => {
        btn.addEventListener('click', () => {
            tabs.forEach((b) => b.classList.remove('active'));
            tabs.forEach((b) => b.classList.add('secondary'));
            btn.classList.add('active');
            btn.classList.remove('secondary');
            const target = btn.dataset.tab;
            applyTab(target);
        });
    });

    const activeBtn = document.querySelector('.market-tabs .tab-btn.active');
    if (activeBtn) {
        applyTab(activeBtn.dataset.tab);
    }

    function setupPagination(container) {
        if (!container) return;
        const size = Number(container.dataset.pageSize || 20);
        const items = Array.from(container.querySelectorAll('.market-row'));
        const controls = container.parentElement?.querySelector('.paged-controls');
        const btn = controls?.querySelector('.load-more');
        if (!btn) return;

        let visible = 0;
        const apply = () => {
            items.forEach((item, idx) => {
                item.classList.toggle('is-hidden', idx >= visible);
            });
            btn.style.display = visible >= items.length ? 'none' : 'inline-flex';
        };
        const showNext = () => {
            visible = Math.min(items.length, visible + size);
            apply();
        };

        btn.addEventListener('click', showNext);
        visible = Math.min(items.length, size);
        apply();
    }

    document.querySelectorAll('.paged-list').forEach(setupPagination);

    const stableIds = new Set([
        'tether','usd-coin','dai','binance-usd','true-usd','paxos-standard','first-digital-usd',
        'ethena-usde','frax','liquity-usd','gemini-dollar','usdd','crvusd','paypal-usd',
        'eurc','tether-eurt','stasis-eurs','agora-dollar','angle-usd','usda','usdb','usde'
    ]);
    const stableSyms = new Set([
        'usdt','usdc','dai','busd','tusd','usdp','fdusd','usde','frax','lusd','gusd','usdd','crvusd','pyusd','eurc','eurt','eurs','usda','usdb'
    ]);
    const l1Ids = new Set([
        'bitcoin','ethereum','solana','binancecoin','cardano','avalanche-2','tron','the-open-network','polkadot',
        'polygon-ecosystem-token','near','aptos','sui','cosmos','algorand','hedera-hashgraph','injective-protocol',
        'fantom','multiversx','tezos','sei-network','arbitrum','optimism'
    ]);

    function buildBadges(coin) {
        const badges = [];
        const rank = Number(coin.rank);
        const mc = Number(coin.market_cap);
        const change24 = coin.change_24h;
        const change7 = coin.change_7d;
        const sym = (coin.symbol || '').toLowerCase();
        const name = (coin.name || '').toLowerCase();
        const cid = (coin.id || '').toLowerCase();

        if (!Number.isNaN(rank) && rank > 0 && rank <= 3) badges.push('<span class="badge top crown" title="Top 3">👑</span>');
        if (!Number.isNaN(rank) && rank > 0 && rank <= 10) badges.push('<span class="badge top medal" title="Top 10">🏅</span>');
        if (!Number.isNaN(mc) && mc >= 100000000000) {
            badges.push('<span class="badge mega gem" title="Mega Cap">💎</span>');
        } else if (!Number.isNaN(mc) && mc >= 10000000000) {
            badges.push('<span class="badge large" title="Large Cap">🏛</span>');
        } else if (!Number.isNaN(mc) && mc >= 1000000000) {
            badges.push('<span class="badge mid" title="Mid Cap">🏙</span>');
        }
        if (change24 != null && change24 >= 5) badges.push('<span class="badge hot flame" title="Hot 24h">🔥</span>');
        if (change24 != null && change24 <= -5) badges.push('<span class="badge cold snow" title="Cold 24h">❄</span>');
        if (change24 != null && Math.abs(change24) >= 8) badges.push('<span class="badge vol bolt" title="High Volatility">⚡</span>');
        if (change7 != null && change7 >= 10) badges.push('<span class="badge up7d rocket" title="Up 7D">🚀</span>');
        if (change7 != null && change7 <= -10) badges.push('<span class="badge down7d dip" title="Down 7D">📉</span>');
        if (stableIds.has(cid) || stableSyms.has(sym) || name.includes('usd') || name.includes('dollar') || name.includes('euro') || name.includes('eur')) {
            badges.push('<span class="badge stable" title="Stablecoin">🪙</span>');
        }
        if (sym === 'btc' || sym === 'eth') badges.push('<span class="badge legacy" title="Legacy Blue Chip">🏆</span>');
        if (l1Ids.has(cid)) badges.push('<span class="badge l1" title="Layer 1">🌐</span>');

        if (!badges.length) {
            badges.push('<span class="badge default" title="Top 50">🔹</span>');
        }

        return badges.join('');
    }

    async function refreshData() {
        try {
            const res = await fetch('/api/summary');
            if (!res.ok) return;
            const data = await res.json();
            if (!data || !data.top_coins) return;
            data.top_coins.forEach((coin) => {
                const row = document.querySelector(`.market-row[data-id="${coin.id}"]`);
                if (!row) return;
                const badgeBox = row.querySelector('.badge-box');
                const priceEl = row.querySelector('[data-price]');
                if (priceEl && coin.price_usd != null) {
                    priceEl.textContent = `$${coin.price_usd.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
                }
                const changeEl = row.querySelector('[data-change]');
                if (changeEl) {
                    if (coin.change_24h != null) {
                        const sign = coin.change_24h >= 0 ? '+' : '';
                        const arrow = coin.change_24h >= 0 ? '▲' : '▼';
                        changeEl.innerHTML = `<span class="change-arrow">${arrow}</span> ${sign}${coin.change_24h.toFixed(2)}% 24h`;
                        changeEl.classList.toggle('up', coin.change_24h >= 0);
                        changeEl.classList.toggle('down', coin.change_24h < 0);
                        changeEl.classList.remove('muted');
                    } else {
                        changeEl.textContent = '— 24h';
                        changeEl.classList.remove('up', 'down');
                        changeEl.classList.add('muted');
                    }
                }
                const change7dEl = row.querySelector('.change-7d');
                if (change7dEl) {
                    if (coin.change_7d != null) {
                        const sign = coin.change_7d >= 0 ? '+' : '';
                        const arrow = coin.change_7d >= 0 ? '▲' : '▼';
                        change7dEl.innerHTML = `<span class="change-arrow">${arrow}</span> ${sign}${Number(coin.change_7d).toFixed(2)}% 7d`;
                        change7dEl.classList.toggle('up', coin.change_7d >= 0);
                        change7dEl.classList.toggle('down', coin.change_7d < 0);
                        change7dEl.classList.remove('muted');
                    } else {
                        change7dEl.textContent = '— 7d';
                        change7dEl.classList.remove('up', 'down');
                        change7dEl.classList.add('muted');
                    }
                }
                if (badgeBox) {
                    badgeBox.innerHTML = buildBadges(coin);
                }
                const volEl = row.querySelector('[data-volume]');
                if (volEl && coin.volume_24h != null) {
                    volEl.textContent = `$${coin.volume_24h.toLocaleString()}`;
                }
                const capEl = row.querySelector('[data-cap]');
                if (capEl && coin.market_cap != null) {
                    capEl.textContent = `$${coin.market_cap.toLocaleString()}`;
                }
            });

            if (data.my_coins) {
                data.my_coins.forEach((coin) => {
                    const row = document.querySelector(`.market-row[data-my-id="${coin.id}"]`);
                    if (!row) return;
                    const priceEl = row.querySelector('[data-price]');
                    if (priceEl && coin.price_usd != null) {
                        priceEl.textContent = `$${Number(coin.price_usd).toLocaleString(undefined, {maximumFractionDigits: 6})}`;
                    }
                    const changeEl = row.querySelector('[data-change]');
                    if (changeEl && coin.change_24h != null) {
                        const sign = coin.change_24h >= 0 ? '+' : '';
                        const arrow = coin.change_24h >= 0 ? '▲' : '▼';
                        changeEl.innerHTML = `<span class="change-arrow">${arrow}</span> ${sign}${Number(coin.change_24h).toFixed(2)}%`;
                        changeEl.classList.toggle('up', coin.change_24h >= 0);
                        changeEl.classList.toggle('down', coin.change_24h < 0);
                    }
                    const volEl = row.querySelector('[data-volume]');
                    if (volEl && coin.volume_24h != null) {
                        volEl.textContent = `$${Number(coin.volume_24h).toLocaleString()}`;
                    }
                    const capEl = row.querySelector('[data-cap]');
                    if (capEl && coin.market_cap != null) {
                        capEl.textContent = `$${Number(coin.market_cap).toLocaleString()}`;
                    }
                });
            }
        } catch (err) {
            // ignore
        }
    }
    setInterval(refreshData, 10000);
</script>
{% endblock %}

