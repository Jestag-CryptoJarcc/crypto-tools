{% extends "base.html" %}
{% set page_title = "My Crypto" %}
{% block content %}
<header class="hero">
    <div class="kicker">PERSONAL</div>
    <h1>My Crypto</h1>
    <p class="lead">A personal snapshot of the coins I track and the notes I keep on each one.</p>
</header>

<section class="grid personal-grid">
    <div class="card wide personal-watchlist" data-widget>
        <button class="expand-close" type="button">Close</button>
        <div class="card-header">
            <h2>My Watchlist</h2>
            <span class="pill">My Coins</span>
        </div>
        {% if my_coins %}
        <div class="market-list paged-list" data-page-size="12">
            {% for coin in my_coins %}
            <div class="market-row">
                <div class="market-coin">
                    {% if coin.image %}
                    <img src="{{ coin.image }}" alt="{{ coin.symbol }} logo" loading="lazy">
                    {% endif %}
                    <div>
                        <strong>{{ coin.name }}</strong>
                        <span class="muted">{{ coin.symbol }}</span>
                    </div>
                </div>
                <div class="market-metrics">
                    <div>
                        <span class="muted">Price</span>
                        <strong>${{ "{:,.6f}".format(coin.price_usd) }}</strong>
                    </div>
                    <div>
                        <span class="muted">24h</span>
                        <strong data-change class="{{ 'up' if coin.change_24h >= 0 else 'down' }}">
                            <span class="change-arrow">{{ '▲' if coin.change_24h >= 0 else '▼' }}</span>
                            {{ "{:+.2f}%".format(coin.change_24h) }}
                        </strong>
                    </div>
                    <div>
                        <span class="muted">Volume</span>
                        <strong>${{ "{:,.0f}".format(coin.volume_24h) }}</strong>
                    </div>
                    <div>
                        <span class="muted">Market Cap</span>
                        <strong>${{ "{:,.0f}".format(coin.market_cap) }}</strong>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="paged-controls">
            <button class="chip secondary load-more" type="button">Load more</button>
        </div>
        {% else %}
        <p class="muted">Watchlist data unavailable.</p>
        {% endif %}
    </div>

    <div class="card featured" data-widget>
        <button class="expand-close" type="button">Close</button>
        <div class="card-header">
            <h2>My Holdings</h2>
        </div>
        {% if holdings %}
        <div class="list">
            {% for h in holdings %}
            <div class="list-item">
                <div>
                    <strong>{{ h.name }}</strong>
                    <span class="muted">{{ h.symbol }}</span>
                </div>
                <span class="muted">{{ h.note }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="muted">No holdings listed yet. Add from admin.</p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    function renderWatchlist(coins) {
        const list = document.querySelector('.personal-watchlist .market-list');
        const controls = document.querySelector('.personal-watchlist .paged-controls');
        const btn = controls?.querySelector('.load-more');
        if (!list) return;
        if (!coins || !coins.length) {
            list.innerHTML = '<p class="muted">Watchlist data unavailable.</p>';
            if (btn) btn.style.display = 'none';
            return;
        }
        list.innerHTML = coins.map((coin) => {
            const img = coin.image ? `<img src="${coin.image}" alt="${coin.symbol} logo" loading="lazy">` : '';
            const changeClass = coin.change_24h >= 0 ? 'up' : 'down';
            const changeArrow = coin.change_24h >= 0 ? '▲' : '▼';
            return `
                <div class="market-row">
                    <div class="market-coin">
                        ${img}
                        <div>
                            <strong>${coin.name}</strong>
                            <span class="muted">${coin.symbol}</span>
                        </div>
                    </div>
                    <div class="market-metrics">
                        <div>
                            <span class="muted">Price</span>
                            <strong>$${Number(coin.price_usd).toLocaleString(undefined, {maximumFractionDigits: 6})}</strong>
                        </div>
                        <div>
                            <span class="muted">24h</span>
                            <strong data-change class="${changeClass}">
                                <span class="change-arrow">${changeArrow}</span>
                                ${coin.change_24h >= 0 ? '+' : ''}${Number(coin.change_24h).toFixed(2)}%
                            </strong>
                        </div>
                        <div>
                            <span class="muted">Volume</span>
                            <strong>$${Number(coin.volume_24h).toLocaleString()}</strong>
                        </div>
                        <div>
                            <span class="muted">Market Cap</span>
                            <strong>$${Number(coin.market_cap).toLocaleString()}</strong>
                        </div>
                    </div>
                </div>`;
        }).join('');
        setupPagination(list, btn, Number(list.dataset.pageSize || 12));
    }

    function renderHoldings(items) {
        const list = document.querySelector('.card.featured .list');
        if (!list) return;
        if (!items || !items.length) {
            list.innerHTML = '<p class="muted">No holdings listed yet. Add from admin.</p>';
            return;
        }
        list.innerHTML = items.map((h) => `
            <div class="list-item">
                <div>
                    <strong>${h.name}</strong>
                    <span class="muted">${h.symbol}</span>
                </div>
                <span class="muted">${h.note || ''}</span>
            </div>
        `).join('');
    }

    function setupPagination(list, btn, size) {
        if (!list || !btn) return;
        const items = Array.from(list.querySelectorAll('.market-row'));
        let visible = Math.min(items.length, size);
        const apply = () => {
            items.forEach((item, idx) => item.classList.toggle('is-hidden', idx >= visible));
            btn.style.display = visible >= items.length ? 'none' : 'inline-flex';
        };
        btn.onclick = () => {
            visible = Math.min(items.length, visible + size);
            apply();
        };
        apply();
    }

    async function refreshPersonal() {
        try {
            const res = await fetch('/api/personal');
            if (!res.ok) return;
            const data = await res.json();
            renderWatchlist(data.my_coins || []);
            renderHoldings(data.holdings || []);
        } catch (err) {
            // ignore
        }
    }

    refreshPersonal();
    setInterval(refreshPersonal, 15000);
</script>
{% endblock %}

